<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive SIP Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-6">
            <h1 class="text-3xl font-bold">Comprehensive SIP Investment Plan</h1>
        </header>

        <section id="executive-summary" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Executive Summary</h2>
            <p id="exec">No executive summary available.</p>
        </section>

        <section id="goal-inputs" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Goal Inputs</h2>
            <div id="goal-inputs-content"></div>
        </section>

        <section id="inflation-adjustment" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Inflation Adjustment</h2>
            <div id="inflation-adjustment-content"></div>
        </section>

        <section id="sip-calculation" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">SIP Calculation</h2>
            <div id="sip-calculation-content"></div>
        </section>

        <section id="asset-allocation-plan" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Asset Allocation Plan</h2>
            <div id="asset-allocation-content"></div>
        </section>

        <section id="allocation-notes" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Allocation Notes</h2>
            <div id="allocation-notes-content"></div>
        </section>

        <section id="sip-projection-table" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">SIP Projection Table (First 12 Months)</h2>
            <table class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Month</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Contribution</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Projected Value</th>
                    </tr>
                </thead>
                <tbody id="projection-table-body"></tbody>
            </table>
        </section>

        <section id="key-recommendations" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Key Recommendations</h2>
            <ul id="recommendations-list"></ul>
        </section>

        <section id="risk-factors" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Risk Factors & Uncertainties</h2>
            <p>Investing in financial markets involves inherent risks, and achieving the target retirement corpus is not guaranteed. Market fluctuations, economic downturns, and changes in interest rates can impact investment returns. The absence of Large Cap funds may increase the overall risk profile of the equity portion, potentially leading to higher volatility. Inflation can erode the purchasing power of returns, and unexpected expenses or changes in financial circumstances can affect the ability to maintain the SIP. It is essential to regularly monitor the investment portfolio, review the asset allocation, and adjust the SIP amount as needed to mitigate these risks and uncertainties. Diversification across different asset classes and fund categories can help reduce the impact of market volatility. Consulting with a qualified financial advisor is recommended to develop a personalized investment strategy that aligns with individual risk tolerance and financial goals. Unexpected global events and regulatory changes can also introduce uncertainties and affect investment outcomes. Moreover, the projected returns are based on historical data and assumptions, and future performance may differ significantly. Consider consulting with a financial advisor.</p>
        </section>

        <section id="validation-summary" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Validation Summary</h2>
            <div id="validation-summary-content"></div>
        </section>

        <section id="charts" class="mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white shadow rounded-2xl p-4">
                    <h3 class="text-lg font-semibold mb-3">SIP Projection Chart</h3>
                    <canvas id="sipProjectionChart"></canvas>
                </div>
                <div class="bg-white shadow rounded-2xl p-4">
                    <h3 class="text-lg font-semibold mb-3">Asset Allocation Chart</h3>
                    <canvas id="sipAllocationChart"></canvas>
                </div>
            </div>
        </section>

        <section id="disclaimer" class="bg-white shadow rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-3">Disclaimer</h2>
            <p>This report is for informational purposes only and does not constitute financial advice. Consult with a qualified financial advisor before making any investment decisions.</p>
        </section>

        <footer class="mt-8 flex gap-3">
            <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded">Print</button>
            <button id="dl" class="bg-green-600 text-white px-4 py-2 rounded">Download</button>
        </footer>

        <script id="sip-data" type="application/json">{}</script>
        <script id="goal-input-json" type="application/json">{}</script>
        <script id="inflation-adjusted-json" type="application/json">{}</script>
        <script id="sip-calc-json" type="application/json">{}</script>
        <script id="allocation-plan-json" type="application/json">{}</script>
        <script id="report-payload" type="application/json">{}</script>
    </div>

    <script>
        (function() {
            function readJSON(id, fb) {
                try {
                    var el = document.getElementById(id);
                    if (!el) return fb;
                    var t = el.textContent || el.innerText || "";
                    if (!t.trim()) return fb;
                    return JSON.parse(t);
                } catch (e) {
                    console.error("Error parsing JSON from " + id + ":", e);
                    return fb;
                }
            }

            var goalInput = window.goal_input_json || readJSON('goal-input-json', {});
            var inflationAdjusted = window.inflation_adjusted_json || readJSON('inflation-adjusted-json', {});
            var sipCalc = window.sip_calc_json || readJSON('sip-calc-json', {});
            var allocationPlan = window.allocation_plan_json || readJSON('allocation-plan-json', {});
            var rp = window.report_payload || readJSON('report-payload', {"executive_summary": "No executive summary available.", "sections": []});
            var cd = window.chart_data_json || readJSON('sip-data', {
                "projection": {
                    "labels": [],
                    "datasets": {
                        "cumulative_contribution": [],
                        "projected_corpus": []
                    }
                },
                "allocation": {
                    "labels": ["Equity", "Debt"],
                    "data": [60, 40]
                }
            });

            // Populate Executive Summary
            document.getElementById('exec').textContent = rp.executive_summary || 'No executive summary available.';


            // Populate Goal Inputs
            var goalInputsContent = document.getElementById('goal-inputs-content');
            if (goalInput) {
                goalInputsContent.innerHTML = `
                    <p><b>Goal Type:</b> ${goalInput.goal_type || 'N/A'}</p>
                    <p><b>Target Amount:</b> ${goalInput.currency || 'INR'} ${goalInput.target_amount || 'N/A'}</p>
                    <p><b>Time Horizon:</b> ${goalInput.time_horizon_years || 'N/A'} years</p>
                    <p><b>Risk Appetite:</b> ${goalInput.risk_appetite || 'N/A'}</p>
                `;
            } else {
                goalInputsContent.textContent = "No goal input data available.";
            }

            // Populate Inflation Adjustment
            var inflationAdjustmentContent = document.getElementById('inflation-adjustment-content');
            if (inflationAdjusted) {
                inflationAdjustmentContent.innerHTML = `
                    <p><b>Inflation Rate:</b> ${inflationAdjusted.inflation_pct || 'N/A'}%</p>
                    <p><b>Unadjusted Target:</b> INR ${inflationAdjusted.unadjusted_target || 'N/A'}</p>
                    <p><b>Adjusted Target:</b> INR ${inflationAdjusted.adjusted_target || 'N/A'}</p>
                `;
            } else {
                inflationAdjustmentContent.textContent = "No inflation adjustment data available.";
            }

            // Populate SIP Calculation
            var sipCalculationContent = document.getElementById('sip-calculation-content');
            if (sipCalc) {
                sipCalculationContent.innerHTML = `
                    <p><b>Monthly Return Rate:</b> ${sipCalc.monthly_return_r || 'N/A'}%</p>
                    <p><b>Number of Months:</b> ${sipCalc.months_n || 'N/A'}</p>
                    <p><b>Adjusted Target:</b> INR ${sipCalc.adjusted_target || 'N/A'}</p>
                    <p><b>Monthly SIP Amount:</b> INR ${sipCalc.monthly_sip || 'N/A'}</p>
                    <p><b>Status:</b> ${sipCalc.status || 'N/A'}</p>
                `;
                if (sipCalc.error) {
                  sipCalculationContent.innerHTML += `<p><b>Error:</b> ${sipCalc.error}</p>`;
                }
            } else {
                sipCalculationContent.textContent = "No SIP calculation data available.";
            }

            // Populate Asset Allocation Plan
            var assetAllocationContent = document.getElementById('asset-allocation-content');
            if (allocationPlan) {
                assetAllocationContent.innerHTML = `
                    <p><b>Equity:</b> ${allocationPlan.equity_percent || 'N/A'}%</p>
                    <p><b>Debt:</b> ${allocationPlan.debt_percent || 'N/A'}%</p>
                    <p><b>Recommended Equity Fund Categories:</b> ${allocationPlan.recommended_fund_categories && allocationPlan.recommended_fund_categories.equity ? allocationPlan.recommended_fund_categories.equity.join(', ') : 'N/A'}</p>
                    <p><b>Recommended Debt Fund Categories:</b> ${allocationPlan.recommended_fund_categories && allocationPlan.recommended_fund_categories.debt ? allocationPlan.recommended_fund_categories.debt.join(', ') : 'N/A'}</p>
                    <p><b>ELSS (Optional):</b> ${allocationPlan.recommended_fund_categories && allocationPlan.recommended_fund_categories.elss_optional !== undefined ? allocationPlan.recommended_fund_categories.elss_optional : 'N/A'}</p>
                `;
            } else {
                assetAllocationContent.textContent = "No asset allocation data available.";
            }

            // Populate Allocation Notes
            var allocationNotesContent = document.getElementById('allocation-notes-content');
            if (allocationPlan && allocationPlan.notes) {
                let notesHTML = '';
                for (const key in allocationPlan.notes) {
                    notesHTML += `<p><b>${key}:</b> ${allocationPlan.notes[key]}</p>`;
                }
                allocationNotesContent.innerHTML = notesHTML;
            } else {
                allocationNotesContent.textContent = "No allocation notes available.";
            }

            // Populate SIP Projection Table
            var projectionTableBody = document.getElementById('projection-table-body');
            if (cd && cd.projection && cd.projection.labels && cd.projection.datasets && cd.projection.datasets.projected_corpus && cd.projection.datasets.cumulative_contribution) {
                const labels = cd.projection.labels;
                const projectedCorpus = cd.projection.datasets.projected_corpus;
                const cumulativeContribution = cd.projection.datasets.cumulative_contribution;

                for (let i = 0; i < Math.min(12, labels.length); i++) {
                    const month = labels[i];
                    const contribution = cumulativeContribution[i];
                    const projectedValue = projectedCorpus[i];

                    const row = `
                        <tr>
                            <td class="px-5 py-3 border-b border-gray-200 bg-white text-sm">${month}</td>
                            <td class="px-5 py-3 border-b border-gray-200 bg-white text-sm">${contribution}</td>
                            <td class="px-5 py-3 border-b border-gray-200 bg-white text-sm">${projectedValue}</td>
                        </tr>
                    `;
                    projectionTableBody.innerHTML += row;
                }
            } else {
                projectionTableBody.innerHTML = "<tr><td colspan='3'>No projection data available.</td></tr>";
            }

            // Populate Key Recommendations
            var recommendationsList = document.getElementById('recommendations-list');
            if (rp && rp.sections) {
                rp.sections.forEach(section => {
                    if (section.title === "Recommendations") {
                        const recommendations = section.content.split("\n").filter(item => item.trim() !== "");
                        recommendations.forEach(recommendation => {
                            const listItem = document.createElement('li');
                            listItem.textContent = recommendation;
                            recommendationsList.appendChild(listItem);
                        });
                    }
                });
            } else {
                recommendationsList.innerHTML = "<li>No recommendations available.</li>";
            }

          // Populate Validation Summary
          var validationSummaryContent = document.getElementById('validation-summary-content');
          if (rp && rp.sections) {
              let validationSection = rp.sections.find(section => section.title === 'Validation Results');
              if (validationSection) {
                  validationSummaryContent.innerHTML = validationSection.content;
              } else {
                  validationSummaryContent.textContent = 'No validation summary available.';
              }
          } else {
              validationSummaryContent.textContent = 'No validation summary available.';
          }

            // Charts
            var proj = cd.projection || {labels: [], datasets: {cumulative_contribution: [], projected_corpus: []}};
            new Chart(document.getElementById('sipProjectionChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: proj.labels || [],
                    datasets: [{
                        label: 'Projected Corpus',
                        data: (proj.datasets && proj.datasets.projected_corpus) || [],
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'Cumulative Contribution',
                        data: (proj.datasets && proj.datasets.cumulative_contribution) || [],
                        fill: false,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            var alloc = cd.allocation || {labels: ["Equity", "Debt"], data: [60, 40]};
            new Chart(document.getElementById('sipAllocationChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: alloc.labels || ["Equity", "Debt"],
                    datasets: [{
                        data: alloc.data || [60, 40],
                        backgroundColor: ['rgb(54, 162, 235)', 'rgb(255, 99, 132)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Download Functionality
            document.getElementById('dl').addEventListener('click', function() {
                var blob = new Blob([document.documentElement.outerHTML], {type: 'text/html'});
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'comprehensive_report.html';
                a.click();
            });
        })();
    </script>
</body>
</html>